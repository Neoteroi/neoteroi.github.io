
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The official documentation website of BlackSheep, a fast ASGI web framework for Python asyncio.">
      
      
        <meta name="author" content="Roberto Prevato">
      
      
        <link rel="canonical" href="https://www.neoteroi.dev/blacksheep/dependency-injection/">
      
      
        <link rel="prev" href="../mvc-project-template/">
      
      
        <link rel="next" href="../openapi/">
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.9">
    
    
      
        <title>Dependency injection - BlackSheep</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/neoteroi.css">
    
      <link rel="stylesheet" href="../css/extra.css?v=20221120">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-T65MX5XNF2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T65MX5XNF2');
</script>

    
    
  
  
    
  
  
  <meta property="og:type" content="website">
  <meta property="og:title" content="BlackSheep - Dependency injection">
  <meta property="og:description" content="The official documentation website of BlackSheep, a fast ASGI web framework for Python asyncio.">
  <meta property="og:url" content="https://www.neoteroi.dev/blacksheep/dependency-injection/">
  <meta property="og:image" content="https://www.neoteroi.dev/blacksheep/img/banner.png">
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1080">
  <meta property="og:image:height" content="568">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@RobertoPrevato">
  <meta name="twitter:creator" content="@RobertoPrevato">
  <meta name="twitter:title" content="BlackSheep - Dependency injection">
  <meta name="twitter:description" content="The official documentation website of BlackSheep, a fast ASGI web framework for Python asyncio.">
  <meta name="twitter:image" content="https://www.neoteroi.dev/blacksheep/img/banner.png">
  <script>
    (function () {
        var fullscreen = localStorage.getItem("FULLSCREEN") || "N";
        if (fullscreen === "Y") {
            document.documentElement.classList.add("fullscreen");
        }
    })();
  </script>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dependency-injection-in-blacksheep" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="BlackSheep" class="md-header__button md-logo" aria-label="BlackSheep" data-md-component="logo">
      
  <img src="../img/logow.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            BlackSheep
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Dependency injection
            
          </span>
        </div>
      </div>
    </div>
    <form id="fullscreen-form" class="md-header__option" data-md-component="fullscreen">
      <input class="md-option" aria-label="Enter full screen" type="radio" name="__fullscreen" id="__fullscreen">
      <label title="Full screen" class="md-header__button md-icon" id="full-screen" for="__fullscreen">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 5h5v2H7v3H5zm9 0h5v5h-2V7h-3zm3 9h2v5h-5v-2h3zm-7 3v2H5v-5h2v3z"/></svg>
      </label>
      <input class="md-option" aria-label="Exit full screen" type="radio" name="__fullscreen" id="__fullscreen_no">
      <label title="Exit full screen" class="md-header__button md-icon" id="full-screen-exit" for="__fullscreen_no">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 14h5v2h-3v3h-2zm-9 0h5v5H8v-3H5zm3-9h2v5H5V8h3zm11 3v2h-5V5h2v3z"/></svg>
      </label>
    </form>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Neoteroi/BlackSheep" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Neoteroi/BlackSheep
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="BlackSheep" class="md-nav__button md-logo" aria-label="BlackSheep" data-md-component="logo">
      
  <img src="../img/logow.svg" alt="logo">

    </a>
    BlackSheep
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Neoteroi/BlackSheep" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Neoteroi/BlackSheep
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting started: basics
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../mvc-project-template/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting started: MVC
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Dependency injection
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Dependency injection
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    <span class="md-ellipsis">
      Demo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#service-resolution" class="md-nav__link">
    <span class="md-ellipsis">
      Service resolution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-class-annotations" class="md-nav__link">
    <span class="md-ellipsis">
      Using class annotations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-service-lifetimes" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding service lifetimes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#options-to-create-services" class="md-nav__link">
    <span class="md-ellipsis">
      Options to create services
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Options to create services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#singleton-example" class="md-nav__link">
    <span class="md-ellipsis">
      Singleton example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registering-a-concrete-class" class="md-nav__link">
    <span class="md-ellipsis">
      Registering a concrete class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registering-an-abstract-class" class="md-nav__link">
    <span class="md-ellipsis">
      Registering an abstract class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-factory-function" class="md-nav__link">
    <span class="md-ellipsis">
      Using a factory function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-implement-a-request-context" class="md-nav__link">
    <span class="md-ellipsis">
      Example: implement a request context
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services-that-require-asynchronous-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Services that require asynchronous initialization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-container-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      The container protocol
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The container protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-punq-instead-of-rodi" class="md-nav__link">
    <span class="md-ellipsis">
      Using Punq instead of Rodi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-dependency-injector-instead-of-rodi" class="md-nav__link">
    <span class="md-ellipsis">
      Using Dependency Injector instead of Rodi
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../openapi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OpenAPI Docs
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../application/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Application
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../routing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Routing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../request-handlers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Request handlers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../requests/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Requests
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Responses
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../templating/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Templating
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../controllers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Controllers
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../middlewares/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Middlewares
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../static-files/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Serving static files
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../websocket/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WebSocket
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../server-sent-events/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Server-sent events
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../authentication/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Authentication
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../authorization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Authorization
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../openid-connect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OpenID Connect
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sessions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sessions
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_22" >
        
          
          <label class="md-nav__link" for="__nav_22" id="__nav_22_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Security
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_22_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_22">
            <span class="md-nav__icon md-icon"></span>
            Security
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CORS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../anti-request-forgery/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Anti-Forgery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataprotection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data protection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hsts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HSTS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../remotes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Remotes
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_23" >
        
          
          <label class="md-nav__link" for="__nav_23" id="__nav_23_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Response features
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_23_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_23">
            <span class="md-nav__icon md-icon"></span>
            Response features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cache-control/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cache control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../compression/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Compression
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_24" >
        
          
          <label class="md-nav__link" for="__nav_24" id="__nav_24_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Examples
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_24_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_24">
            <span class="md-nav__icon md-icon"></span>
            Examples
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/marshmallow/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Marshmallow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_25" >
        
          
          <label class="md-nav__link" for="__nav_25" id="__nav_25_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Production deployments
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_25_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_25">
            <span class="md-nav__icon md-icon"></span>
            Production deployments
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../behind-proxies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Behind proxies
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Settings
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../binders/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Binders
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../background-tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Background tasks
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../mounting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mounting apps
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../client/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTP Client
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    More about the CLI
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../versions/migrating-to-v2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    From V1 to V2
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../develop-with-https/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Develop using HTTPS
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../asgi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ASGI
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../extensions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extensions
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Neoteroi docs home
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Introduction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#demo" class="md-nav__link">
    <span class="md-ellipsis">
      Demo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#service-resolution" class="md-nav__link">
    <span class="md-ellipsis">
      Service resolution
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-class-annotations" class="md-nav__link">
    <span class="md-ellipsis">
      Using class annotations
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-service-lifetimes" class="md-nav__link">
    <span class="md-ellipsis">
      Understanding service lifetimes
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#options-to-create-services" class="md-nav__link">
    <span class="md-ellipsis">
      Options to create services
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Options to create services">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#singleton-example" class="md-nav__link">
    <span class="md-ellipsis">
      Singleton example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registering-a-concrete-class" class="md-nav__link">
    <span class="md-ellipsis">
      Registering a concrete class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#registering-an-abstract-class" class="md-nav__link">
    <span class="md-ellipsis">
      Registering an abstract class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-factory-function" class="md-nav__link">
    <span class="md-ellipsis">
      Using a factory function
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-implement-a-request-context" class="md-nav__link">
    <span class="md-ellipsis">
      Example: implement a request context
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#services-that-require-asynchronous-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      Services that require asynchronous initialization
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-container-protocol" class="md-nav__link">
    <span class="md-ellipsis">
      The container protocol
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The container protocol">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-punq-instead-of-rodi" class="md-nav__link">
    <span class="md-ellipsis">
      Using Punq instead of Rodi
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-dependency-injector-instead-of-rodi" class="md-nav__link">
    <span class="md-ellipsis">
      Using Dependency Injector instead of Rodi
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                

  
                  


<h1 id="dependency-injection-in-blacksheep">Dependency injection in BlackSheep<a class="headerlink" href="#dependency-injection-in-blacksheep" title="Permanent link">&para;</a></h1>
<p>The getting started tutorials demonstrate how route and query string parameters
can be directly injected into request handlers through function signatures.
Additionally, BlackSheep supports the dependency injection of services
configured for the application. This page covers:</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> An introduction to dependency injection in BlackSheep, with a focus on Rodi.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Service resolution.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Service lifetime.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Options to create services.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Examples of dependency injection.</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> How to use alternatives to Rodi.</li>
</ul>
<div class="admonition">
<p class="admonition-title">Rodi's documentation</p>
<p>Detailed documentation for Rodi can be found at: <a href="/rodi/"><em>Rodi</em></a>.</p>
</div>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>The <code>Application</code> object exposes a <code>services</code> property that can be used to configure services. When the function signature of a request handler references a type that is registered as a service, an instance of that type is automatically injected when the request handler is called.</p>
<p>Consider this example:</p>
<ul>
<li>Some context is necessary to handle certain web requests (for example, a
  database connection pool).</li>
<li>A class that contains this context can be configured in application services
  before the application starts.</li>
<li>Request handlers have this context automatically injected.</li>
</ul>
<h3 id="demo">Demo<a class="headerlink" href="#demo" title="Permanent link">&para;</a></h3>
<p>Starting from a minimal environment as described in the <a href="../getting-started/">getting started
tutorial</a>, create a <code>foo.py</code> file with the following
contents, inside a <code>domain</code> folder:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>.
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>├── domain
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>│   ├── __init__.py
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>│   └── foo.py
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>└── server.py
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># domain/foo.py</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="p">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s2">&quot;Foo&quot;</span>
</code></pre></div>
<p>Import the new class in <code>server.py</code>, and register the type in <code>app.services</code>
as in this example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># server.py</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep</span><span class="w"> </span><span class="kn">import</span> <span class="n">Application</span><span class="p">,</span> <span class="n">get</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">domain.foo</span><span class="w"> </span><span class="kn">import</span> <span class="n">Foo</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="hll"><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>  <span class="c1"># &lt;-- register Foo type as a service</span>
</span><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="n">Foo</span><span class="p">):</span>  <span class="c1"># &lt;-- foo is referenced in type annotation</span>
</span><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">foo</span><span class="o">.</span><span class="n">foo</span><span class="si">}</span><span class="s2">!&quot;</span>
</code></pre></div>
<p>An instance of <code>Foo</code> is injected automatically for every web request to "/".</p>
<p>Dependency injection is implemented in a dedicated library:
<a href="https://github.com/neoteroi/rodi">Rodi</a>. Rodi implements dependency injection
in an unobtrusive way: it works by inspecting code and doesn't require altering
the source code of the types it resolves.</p>
<h2 id="service-resolution">Service resolution<a class="headerlink" href="#service-resolution" title="Permanent link">&para;</a></h2>
<p>Rodi automatically resolves dependency graphs when a resolved type depends on
other types. In the following example, instances of <code>A</code> are automatically
created when resolving <code>Foo</code> because the <code>__init__</code> method in <code>Foo</code> requires an
instance of <code>A</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># domain/foo.py</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">:</span>
</span><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="k">pass</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="p">:</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependency</span><span class="p">:</span> <span class="n">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dependency</span> <span class="o">=</span> <span class="n">dependency</span>
</code></pre></div>
<p>Both types must be registered in <code>app.services</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># server.py</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep</span><span class="w"> </span><span class="kn">import</span> <span class="n">Application</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">text</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">domain.foo</span><span class="w"> </span><span class="kn">import</span> <span class="n">A</span><span class="p">,</span> <span class="n">Foo</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="hll"><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_transient</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="hll"><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
</span><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="n">Foo</span><span class="p">):</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="k">return</span> <span class="n">text</span><span class="p">(</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="s2">        A: </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">dependency</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="s2">        &quot;&quot;&quot;</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>    <span class="p">)</span>
</code></pre></div>
<p>Produces a response like the following at "/":</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>        A: 140289521293056
</code></pre></div>
<h2 id="using-class-annotations">Using class annotations<a class="headerlink" href="#using-class-annotations" title="Permanent link">&para;</a></h2>
<p>It is possible to use class properties, like in the example below:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>    <span class="k">pass</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="p">:</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="hll">    <span class="n">dependency</span><span class="p">:</span> <span class="n">A</span>
</span></code></pre></div>
<h2 id="understanding-service-lifetimes">Understanding service lifetimes<a class="headerlink" href="#understanding-service-lifetimes" title="Permanent link">&para;</a></h2>
<p><code>rodi</code> supports types having one of these lifetimes:</p>
<ul>
<li><strong>singleton</strong> - instantiated only once.</li>
<li><strong>transient</strong> - services are instantiated every time they are required.</li>
<li><strong>scoped</strong> - instantiated once per web request.</li>
</ul>
<p>Consider the following example, where a type <code>A</code> is registered as transient,
<code>B</code> as scoped, <code>C</code> as singleton:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># domain/foo.py</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">:</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>    <span class="o">...</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">:</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>    <span class="o">...</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">C</span><span class="p">:</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>    <span class="o">...</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="p">:</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a1</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">a2</span><span class="p">:</span> <span class="n">A</span><span class="p">,</span> <span class="n">b1</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="n">b2</span><span class="p">:</span> <span class="n">B</span><span class="p">,</span> <span class="n">c1</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="n">c2</span><span class="p">:</span> <span class="n">C</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">a2</span> <span class="o">=</span> <span class="n">a2</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">b1</span> <span class="o">=</span> <span class="n">b1</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">b2</span> <span class="o">=</span> <span class="n">b2</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># server.py</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep</span><span class="w"> </span><span class="kn">import</span> <span class="n">Application</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">text</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">domain.foo</span><span class="w"> </span><span class="kn">import</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">Foo</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_transient</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_singleton</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="n">Foo</span><span class="p">):</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="k">return</span> <span class="n">text</span><span class="p">(</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="s2">        A1: </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="s2">        A2: </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">a2</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="s2">        B1: </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">b1</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="s2">        B2: </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">b2</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="s2">        C1: </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">c1</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="s2">        C2: </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">c2</span><span class="p">)</span><span class="si">}</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="s2">        &quot;&quot;&quot;</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a>    <span class="p">)</span>
</code></pre></div>
<p>Produces responses like the following at "/":</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Request 1</label><label for="__tabbed_1_2">Request 2</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>        A1: 139976289977296
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>        A2: 139976289977680
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>        B1: 139976289977584
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>        B2: 139976289977584
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>        C1: 139976289978736
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a>        C2: 139976289978736
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>        A1: 139976289979888
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>        A2: 139976289979936
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>        B1: 139976289979988
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>        B2: 139976289979988
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        C1: 139976289978736
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>        C2: 139976289978736
</code></pre></div>
</div>
</div>
</div>
<ul>
<li>Transient services are created every time they are needed (A).</li>
<li>Scoped services are created once per web request (B).</li>
<li>Singleton services are instantiated only once and reused across the application (C).</li>
</ul>
<h2 id="options-to-create-services">Options to create services<a class="headerlink" href="#options-to-create-services" title="Permanent link">&para;</a></h2>
<p>Rodi provides several ways to define and instantiate services.</p>
<ol>
<li>registering an exact instance as a singleton</li>
<li>registering a concrete class by its type</li>
<li>registering an abstract class and one of its concrete implementations</li>
<li>registering a service using a factory function</li>
</ol>
<p>For detailed information on this subject, refer to the Rodi documentation:
<a href="https://www.neoteroi.dev/rodi/registering-types/"><em>Registering types</em></a>.</p>
<h4 id="singleton-example">Singleton example<a class="headerlink" href="#singleton-example" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ServiceSettings</span><span class="p">:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>        <span class="n">oauth_application_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>        <span class="n">oauth_application_secret</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="p">):</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_application_id</span> <span class="o">=</span> <span class="n">oauth_application_id</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">oauth_application_secret</span> <span class="o">=</span> <span class="n">oauth_application_secret</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">ServiceSettings</span><span class="p">(</span><span class="s2">&quot;00000000001&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OAUTH_APP_SECRET&quot;</span><span class="p">])</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="p">)</span>
</code></pre></div>
<h4 id="registering-a-concrete-class">Registering a concrete class<a class="headerlink" href="#registering-a-concrete-class" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">HelloHandler</span><span class="p">:</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">greetings</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>        <span class="k">return</span> <span class="s2">&quot;Hello&quot;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_transient</span><span class="p">(</span><span class="n">HelloHandler</span><span class="p">)</span>
</code></pre></div>
<h4 id="registering-an-abstract-class">Registering an abstract class<a class="headerlink" href="#registering-an-abstract-class" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep.server.responses</span><span class="w"> </span><span class="kn">import</span> <span class="n">json</span><span class="p">,</span> <span class="n">not_found</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="c1"># domain class and abstract repository defined in a dedicated package for</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="c1"># domain objects</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="nd">@dataclass</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">Cat</span><span class="p">:</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">CatsRepository</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>
<a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>    <span class="nd">@abstractmethod</span>
<a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_cat_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Cat</span><span class="p">]:</span>
<a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="k">pass</span>
<a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>
<a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a><span class="c1"># ------------------</span>
<a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>
<a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="c1"># the concrete implementation will be defined in a dedicated package</span>
<a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a><span class="k">class</span><span class="w"> </span><span class="nc">PostgreSQLCatsRepository</span><span class="p">(</span><span class="n">CatsRepository</span><span class="p">):</span>
<a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_cat_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Cat</span><span class="p">]:</span>
<a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>        <span class="c1"># TODO: implement</span>
<a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not implemented&quot;</span><span class="p">)</span>
<a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>
<a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a><span class="c1"># ------------------</span>
<a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>
<a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a><span class="c1"># register the abstract class and its concrete implementation when configuring</span>
<a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a><span class="c1"># the application</span>
<a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">CatsRepository</span><span class="p">,</span> <span class="n">PostgreSQLCatsRepository</span><span class="p">)</span>
<a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>
<a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>
<a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a><span class="c1"># a request handler needing the CatsRepository doesn&#39;t need to know about</span>
<a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a><span class="c1"># the exact implementation (e.g. PostgreSQL, SQLite, etc.)</span>
<a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/api/cats/</span><span class="si">{cat_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_cat</span><span class="p">(</span><span class="n">cat_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">repo</span><span class="p">:</span> <span class="n">CatsRepository</span><span class="p">):</span>
<a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>
<a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a>    <span class="n">cat</span> <span class="o">=</span> <span class="k">await</span> <span class="n">repo</span><span class="o">.</span><span class="n">get_cat_by_id</span><span class="p">(</span><span class="n">cat_id</span><span class="p">)</span>
<a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>
<a id="__codelineno-13-45" name="__codelineno-13-45" href="#__codelineno-13-45"></a>    <span class="k">if</span> <span class="n">cat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-13-46" name="__codelineno-13-46" href="#__codelineno-13-46"></a>        <span class="k">return</span> <span class="n">not_found</span><span class="p">()</span>
<a id="__codelineno-13-47" name="__codelineno-13-47" href="#__codelineno-13-47"></a>
<a id="__codelineno-13-48" name="__codelineno-13-48" href="#__codelineno-13-48"></a>    <span class="k">return</span> <span class="n">json</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
</code></pre></div>
<h4 id="using-a-factory-function">Using a factory function<a class="headerlink" href="#using-a-factory-function" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Something</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="k">def</span><span class="w"> </span><span class="nf">something_factory</span><span class="p">(</span><span class="n">services</span><span class="p">,</span> <span class="n">activating_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Something</span><span class="p">:</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>    <span class="k">return</span> <span class="n">Something</span><span class="p">(</span><span class="s2">&quot;Factory Example&quot;</span><span class="p">)</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_transient_by_factory</span><span class="p">(</span><span class="n">something_factory</span><span class="p">)</span>
</code></pre></div>
<h4 id="example-implement-a-request-context">Example: implement a request context<a class="headerlink" href="#example-implement-a-request-context" title="Permanent link">&para;</a></h4>
<p>A good example of a scoped service is one used to assign each web request with
a trace id that can be used to identify requests for logging purposes.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">uuid4</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">OperationContext</span><span class="p">:</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_trace_id</span> <span class="o">=</span> <span class="n">uuid4</span><span class="p">()</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    <span class="nd">@property</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">trace_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UUID</span><span class="p">:</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_id</span>
</code></pre></div>
<p>Register the <code>OperationContext</code> type as a scoped service, this way it is
instantiated once per web request:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_scoped</span><span class="p">(</span><span class="n">OperationContext</span><span class="p">)</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">OperationContext</span><span class="p">):</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="k">return</span> <span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request ID: </span><span class="si">{</span><span class="n">context</span><span class="o">.</span><span class="n">trace_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<h2 id="services-that-require-asynchronous-initialization">Services that require asynchronous initialization<a class="headerlink" href="#services-that-require-asynchronous-initialization" title="Permanent link">&para;</a></h2>
<p>Services that require asynchronous initialization can be configured using
application events. The recommended way is using the <code>lifespan</code> context
manager, like described in the example below.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span>
<span class="normal"><a href="#__codelineno-17-21">21</a></span>
<span class="normal"><a href="#__codelineno-17-22">22</a></span>
<span class="normal"><a href="#__codelineno-17-23">23</a></span>
<span class="normal"><a href="#__codelineno-17-24">24</a></span>
<span class="normal"><a href="#__codelineno-17-25">25</a></span>
<span class="normal"><a href="#__codelineno-17-26">26</a></span>
<span class="normal"><a href="#__codelineno-17-27">27</a></span>
<span class="normal"><a href="#__codelineno-17-28">28</a></span>
<span class="normal"><a href="#__codelineno-17-29">29</a></span>
<span class="normal"><a href="#__codelineno-17-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep</span><span class="w"> </span><span class="kn">import</span> <span class="n">Application</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep.client.pool</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientConnectionPools</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep.client.session</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClientSession</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="hll"><span class="nd">@app</span><span class="o">.</span><span class="n">lifespan</span>
</span><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">register_http_client</span><span class="p">():</span>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a>    <span class="k">async</span> <span class="k">with</span> <span class="n">ClientSession</span><span class="p">(</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a>        <span class="n">pools</span><span class="o">=</span><span class="n">ClientConnectionPools</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">())</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a>    <span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;HTTP client created and registered as singleton&quot;</span><span class="p">)</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="hll">        <span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ClientSession</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">client</span><span class="p">)</span>
</span><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="hll">        <span class="k">yield</span>
</span><a id="__codelineno-17-17" name="__codelineno-17-17"></a>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="hll">    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;HTTP client disposed of&quot;</span><span class="p">)</span>
</span><a id="__codelineno-17-19" name="__codelineno-17-19"></a>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="hll"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">http_client</span><span class="p">:</span> <span class="n">ClientSession</span><span class="p">):</span>
</span><a id="__codelineno-17-23" name="__codelineno-17-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">http_client</span><span class="p">)</span>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a>    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;client_instance_id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">(</span><span class="n">http_client</span><span class="p">)}</span>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">44777</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="n">lifespan</span><span class="o">=</span><span class="s2">&quot;on&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Here are the key points describing the logic of using the <code>lifespan</code> decorator:</p>
<ul>
<li><strong>Purpose</strong>: The <code>@app.lifespan</code> decorator is used to define asynchronous
  setup and teardown logic for an application, such as initializing and
  disposing of resources.</li>
<li><strong>Setup Phase</strong>: Code before the <code>yield</code> statement is executed when the
  application starts. This is typically used to initialize resources (e.g.,
  creating an HTTP client, database connections, or other services).</li>
<li><strong>Resource Registration</strong>: During the setup phase, resources can be
  registered as services in the application's dependency injection container,
  making them available for injection into request handlers.</li>
<li><strong>Teardown Phase</strong>: Code after the <code>yield</code> statement is executed when the
  application stops. This is used to clean up or dispose of resources (e.g.,
  closing connections or releasing memory).</li>
<li><strong>Singleton Resource Management</strong>: The <code>@lifespan</code> decorator is particularly
  useful for managing singleton resources that need to persist for the
  application's lifetime.</li>
<li><strong>Example Use Case</strong>: In the provided example, an <code>HTTP client</code> is created
  and registered as a singleton during the setup phase, and it is disposed of
  during the teardown phase.</li>
</ul>
<hr />
<p>Otherwise, it is possible to use the <code>on_start</code> callback, like in the following
example, to register a service that requires asynchronous initialization:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep</span><span class="w"> </span><span class="kn">import</span> <span class="n">Application</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">text</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">()</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">Example</span><span class="p">:</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="hll"><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">configure_something</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">Application</span><span class="p">):</span>
</span><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="hll">    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># simulate 500 ms delay</span>
</span><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="hll">
</span><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="hll">    <span class="c1"># Note: this works with Rodi! If you use a different kind of DI,</span>
</span><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="hll">    <span class="c1"># implement the desired logic in your connector object / ContainerProtocor</span>
</span><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="hll">    <span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add_instance</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="s2">&quot;Hello World&quot;</span><span class="p">))</span>
</span><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="hll">
</span><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="n">app</span><span class="o">.</span><span class="n">on_start</span> <span class="o">+=</span> <span class="n">configure_something</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">service</span><span class="p">:</span> <span class="n">Example</span><span class="p">):</span>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>    <span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="n">text</span>
</code></pre></div>
<p>Services that require disposal can be disposed of in the <code>on_stop</code> callback:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispose_example</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">Application</span><span class="p">):</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>    <span class="n">service</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">Example</span><span class="p">)</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="hll">    <span class="k">await</span> <span class="n">service</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
</span><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="hll"><span class="n">app</span><span class="o">.</span><span class="n">on_stop</span> <span class="o">+=</span> <span class="n">dispose_example</span>
</span></code></pre></div>
<h2 id="the-container-protocol">The container protocol<a class="headerlink" href="#the-container-protocol" title="Permanent link">&para;</a></h2>
<p>Since version 2, BlackSheep supports alternatives to <code>rodi</code> for dependency
injection. The <code>services</code> property of the <code>Application</code> class needs to conform
to the following container protocol:</p>
<ul>
<li>The <code>register</code> method to register types.</li>
<li>The <code>resolve</code> method to resolve instances of types.</li>
<li>The <code>__contains__</code> method to describe whether a type is defined inside the
  container.</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ContainerProtocol</span><span class="p">:</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="sd">    Generic interface of DI Container that can register and resolve services,</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="sd">    and tell if a type is configured.</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Registers a type in the container, with optional arguments.&quot;&quot;&quot;</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Activates an instance of the given type, with optional arguments.&quot;&quot;&quot;</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="sd">        Returns a value indicating whether a given type is configured in this container.</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="sd">        &quot;&quot;&quot;</span>
</code></pre></div>
<h3 id="using-punq-instead-of-rodi">Using Punq instead of Rodi<a class="headerlink" href="#using-punq-instead-of-rodi" title="Permanent link">&para;</a></h3>
<p>The following example demonstrates how to use
<a href="https://github.com/bobthemighty/punq"><code>punq</code></a> for dependency injection as an
alternative to <code>rodi</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">punq</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep</span><span class="w"> </span><span class="kn">import</span> <span class="n">Application</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep.server.controllers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Controller</span><span class="p">,</span> <span class="n">get</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="p">:</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="s2">&quot;Foo&quot;</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>
<a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">PunqDI</span><span class="p">:</span>
</span><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="sd">    BlackSheep DI container implemented with punq</span>
<a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>
<a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="sd">    https://github.com/bobthemighty/punq</span>
<a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">punq</span><span class="o">.</span><span class="n">Container</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">container</span>
<a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>
<a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>
<a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">obj_type</span><span class="p">))</span>
<a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>
<a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a>        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">registrations</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
<a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a>
<a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a>
<a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="hll"><span class="n">container</span> <span class="o">=</span> <span class="n">punq</span><span class="o">.</span><span class="n">Container</span><span class="p">()</span>
</span><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="hll"><span class="n">container</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Foo</span><span class="p">)</span>
</span><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a>
<a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="hll"><span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">(</span><span class="n">services</span><span class="o">=</span><span class="n">PunqDI</span><span class="p">(</span><span class="n">container</span><span class="p">),</span> <span class="n">show_error_details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>
<a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>
<a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a><span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">foo</span><span class="p">:</span> <span class="n">Foo</span><span class="p">):</span>  <span class="c1"># &lt;-- foo is referenced in type annotation</span>
<a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a>    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">foo</span><span class="o">.</span><span class="n">foo</span><span class="si">}</span><span class="s2">!&quot;</span>
<a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a>
<a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a>
<a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a><span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">:</span>
<a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">greetings</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">greetings</span> <span class="o">=</span> <span class="n">greetings</span>
<a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a>
<a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>
<a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a><span class="n">container</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Settings</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">Settings</span><span class="p">(</span><span class="s2">&quot;example&quot;</span><span class="p">))</span>
<a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a>
<a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a>
<a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a><span class="k">class</span><span class="w"> </span><span class="nc">Home</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
<a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">:</span> <span class="n">Settings</span><span class="p">):</span>
<a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a>        <span class="c1"># controllers are instantiated dynamically at every web request</span>
<a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
<a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a>
<a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">on_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
<a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[*] Received a request!!&quot;</span><span class="p">)</span>
<a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a>
<a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">greet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">greetings</span>
<a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a>
<a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a>    <span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/home&quot;</span><span class="p">)</span>
<a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">greet</span><span class="p">()</span>
<a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a>
<a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a>
<a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">uvicorn</span>
<a id="__codelineno-21-73" name="__codelineno-21-73" href="#__codelineno-21-73"></a>
<a id="__codelineno-21-74" name="__codelineno-21-74" href="#__codelineno-21-74"></a>    <span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">44777</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>
</code></pre></div>
<p>It is also possible to configure the dependency injection container using the
<code>settings</code> namespace, like in the following example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep.settings.di</span><span class="w"> </span><span class="kn">import</span> <span class="n">di_settings</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">default_container_factory</span><span class="p">():</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>    <span class="k">return</span> <span class="n">PunqDI</span><span class="p">(</span><span class="n">punq</span><span class="o">.</span><span class="n">Container</span><span class="p">())</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="n">di_settings</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">default_container_factory</span><span class="p">)</span>
</code></pre></div>
<div class="admonition danger">
<p class="admonition-title">Dependency injection libraries vary.</p>
<p>Some features might not be supported when using a different kind of container,
because not all libraries for dependency injection implement the notion of
<code>singleton</code>, <code>scoped</code>, and <code>transient</code> (most only implement <code>singleton</code> and
<code>transient</code>).</p>
</div>
<h3 id="using-dependency-injector-instead-of-rodi">Using Dependency Injector instead of Rodi<a class="headerlink" href="#using-dependency-injector-instead-of-rodi" title="Permanent link">&para;</a></h3>
<p>The following example illustrates how to use <a href="https://python-dependency-injector.ets-labs.org/">Dependency Injector</a> instead of Rodi.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">  1</a></span>
<span class="normal"><a href="#__codelineno-23-2">  2</a></span>
<span class="normal"><a href="#__codelineno-23-3">  3</a></span>
<span class="normal"><a href="#__codelineno-23-4">  4</a></span>
<span class="normal"><a href="#__codelineno-23-5">  5</a></span>
<span class="normal"><a href="#__codelineno-23-6">  6</a></span>
<span class="normal"><a href="#__codelineno-23-7">  7</a></span>
<span class="normal"><a href="#__codelineno-23-8">  8</a></span>
<span class="normal"><a href="#__codelineno-23-9">  9</a></span>
<span class="normal"><a href="#__codelineno-23-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-23-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-23-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-23-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-23-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-23-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-23-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-23-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-23-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-23-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-23-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-23-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-23-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-23-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-23-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-23-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-23-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-23-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-23-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-23-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-23-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-23-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-23-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-23-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-23-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-23-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-23-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-23-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-23-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-23-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-23-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-23-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-23-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-23-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-23-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-23-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-23-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-23-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-23-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-23-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-23-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-23-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-23-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-23-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-23-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-23-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-23-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-23-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-23-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-23-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-23-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-23-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-23-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-23-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-23-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-23-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-23-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-23-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-23-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-23-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-23-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-23-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-23-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-23-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-23-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-23-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-23-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-23-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-23-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-23-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-23-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-23-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-23-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-23-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-23-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-23-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-23-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-23-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-23-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-23-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-23-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-23-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-23-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-23-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-23-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-23-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-23-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-23-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-23-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-23-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-23-100">100</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">get_type_hints</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="hll"><span class="kn">from</span><span class="w"> </span><span class="nn">dependency_injector</span><span class="w"> </span><span class="kn">import</span> <span class="n">containers</span><span class="p">,</span> <span class="n">providers</span>
</span><a id="__codelineno-23-4" name="__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">blacksheep</span><span class="w"> </span><span class="kn">import</span> <span class="n">Application</span><span class="p">,</span> <span class="n">get</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="n">T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;T&quot;</span><span class="p">)</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">APIClient</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">SomeService</span><span class="p">:</span>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_client</span><span class="p">:</span> <span class="n">APIClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="n">api_client</span>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="hll"><span class="c1"># Define the Dependency Injector container</span>
</span><a id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">AppContainer</span><span class="p">(</span><span class="n">containers</span><span class="o">.</span><span class="n">DeclarativeContainer</span><span class="p">):</span>
</span><a id="__codelineno-23-21" name="__codelineno-23-21"></a><span class="hll">    <span class="n">APIClient</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Singleton</span><span class="p">(</span><span class="n">APIClient</span><span class="p">)</span>
</span><a id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="hll">    <span class="n">SomeService</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span>
</span><a id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="hll">        <span class="n">SomeService</span><span class="p">,</span> <span class="n">api_client</span><span class="o">=</span><span class="n">APIClient</span>
</span><a id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="hll">    <span class="p">)</span>
</span><a id="__codelineno-23-25" name="__codelineno-23-25"></a>
<a id="__codelineno-23-26" name="__codelineno-23-26"></a>
<a id="__codelineno-23-27" name="__codelineno-23-27"></a><span class="c1"># Create the container instance</span>
<a id="__codelineno-23-28" name="__codelineno-23-28"></a><span class="n">container</span> <span class="o">=</span> <span class="n">AppContainer</span><span class="p">()</span>
<a id="__codelineno-23-29" name="__codelineno-23-29"></a>
<a id="__codelineno-23-30" name="__codelineno-23-30"></a>
<a id="__codelineno-23-31" name="__codelineno-23-31"></a><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">DependencyInjectorConnector</span><span class="p">:</span>
</span><a id="__codelineno-23-32" name="__codelineno-23-32"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-23-33" name="__codelineno-23-33"></a><span class="sd">    This class connects a Dependency Injector container with a</span>
<a id="__codelineno-23-34" name="__codelineno-23-34"></a><span class="sd">    BlackSheep application.</span>
<a id="__codelineno-23-35" name="__codelineno-23-35"></a><span class="sd">    Dependencies are registered using the code API offered by</span>
<a id="__codelineno-23-36" name="__codelineno-23-36"></a><span class="sd">    Dependency Injector. The BlackSheep application activates services</span>
<a id="__codelineno-23-37" name="__codelineno-23-37"></a><span class="sd">    using the container when needed.</span>
<a id="__codelineno-23-38" name="__codelineno-23-38"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-23-39" name="__codelineno-23-39"></a>
<a id="__codelineno-23-40" name="__codelineno-23-40"></a><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">containers</span><span class="o">.</span><span class="n">Container</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><a id="__codelineno-23-41" name="__codelineno-23-41"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_container</span> <span class="o">=</span> <span class="n">container</span>
</span><a id="__codelineno-23-42" name="__codelineno-23-42"></a>
<a id="__codelineno-23-43" name="__codelineno-23-43"></a><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><a id="__codelineno-23-44" name="__codelineno-23-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-23-45" name="__codelineno-23-45"></a><span class="sd">        Registers a type with the container.</span>
<a id="__codelineno-23-46" name="__codelineno-23-46"></a><span class="sd">        The code below inspects the object&#39;s constructor&#39;s types annotations to</span>
<a id="__codelineno-23-47" name="__codelineno-23-47"></a><span class="sd">        automatically configure the provider to activate the type.</span>
<a id="__codelineno-23-48" name="__codelineno-23-48"></a>
<a id="__codelineno-23-49" name="__codelineno-23-49"></a><span class="sd">        It is not necessary to use @inject or Provide core on the __init__ method. This</span>
<a id="__codelineno-23-50" name="__codelineno-23-50"></a><span class="sd">        helps reducing code verbosity and keeping the source code not polluted by DI</span>
<a id="__codelineno-23-51" name="__codelineno-23-51"></a><span class="sd">        specific code.</span>
<a id="__codelineno-23-52" name="__codelineno-23-52"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-23-53" name="__codelineno-23-53"></a>        <span class="n">constructor</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-23-54" name="__codelineno-23-54"></a>
<a id="__codelineno-23-55" name="__codelineno-23-55"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">constructor</span><span class="p">:</span>
<a id="__codelineno-23-56" name="__codelineno-23-56"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-23-57" name="__codelineno-23-57"></a>                <span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">obj_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> does not have an __init__ method.&quot;</span>
<a id="__codelineno-23-58" name="__codelineno-23-58"></a>            <span class="p">)</span>
<a id="__codelineno-23-59" name="__codelineno-23-59"></a>
<a id="__codelineno-23-60" name="__codelineno-23-60"></a>        <span class="c1"># Get the type hints for the constructor parameters</span>
<a id="__codelineno-23-61" name="__codelineno-23-61"></a>        <span class="n">type_hints</span> <span class="o">=</span> <span class="n">get_type_hints</span><span class="p">(</span><span class="n">constructor</span><span class="p">)</span>
<a id="__codelineno-23-62" name="__codelineno-23-62"></a>
<a id="__codelineno-23-63" name="__codelineno-23-63"></a>        <span class="c1"># Exclude &#39;self&#39; from the parameters</span>
<a id="__codelineno-23-64" name="__codelineno-23-64"></a>        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-23-65" name="__codelineno-23-65"></a>            <span class="n">param_name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="n">param_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-23-66" name="__codelineno-23-66"></a>            <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_type</span> <span class="ow">in</span> <span class="n">type_hints</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a id="__codelineno-23-67" name="__codelineno-23-67"></a>            <span class="k">if</span> <span class="n">param_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="s2">&quot;return&quot;</span><span class="p">}</span>
<a id="__codelineno-23-68" name="__codelineno-23-68"></a>            <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="n">param_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-23-69" name="__codelineno-23-69"></a>        <span class="p">}</span>
<a id="__codelineno-23-70" name="__codelineno-23-70"></a>
<a id="__codelineno-23-71" name="__codelineno-23-71"></a>        <span class="c1"># Create a provider for the type with its dependencies</span>
<a id="__codelineno-23-72" name="__codelineno-23-72"></a>        <span class="n">provider</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span><span class="n">obj_type</span><span class="p">,</span> <span class="o">**</span><span class="n">dependencies</span><span class="p">)</span>
<a id="__codelineno-23-73" name="__codelineno-23-73"></a>        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">provider</span><span class="p">)</span>
<a id="__codelineno-23-74" name="__codelineno-23-74"></a>
<a id="__codelineno-23-75" name="__codelineno-23-75"></a><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
</span><a id="__codelineno-23-76" name="__codelineno-23-76"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolves an instance of the given type.&quot;&quot;&quot;</span>
<a id="__codelineno-23-77" name="__codelineno-23-77"></a>        <span class="n">provider</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="n">obj_type</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-23-78" name="__codelineno-23-78"></a>        <span class="k">if</span> <span class="n">provider</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-23-79" name="__codelineno-23-79"></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
<a id="__codelineno-23-80" name="__codelineno-23-80"></a>                <span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">obj_type</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not registered in the container.&quot;</span>
<a id="__codelineno-23-81" name="__codelineno-23-81"></a>            <span class="p">)</span>
<a id="__codelineno-23-82" name="__codelineno-23-82"></a>        <span class="k">return</span> <span class="n">provider</span><span class="p">()</span>
<a id="__codelineno-23-83" name="__codelineno-23-83"></a>
<a id="__codelineno-23-84" name="__codelineno-23-84"></a><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><a id="__codelineno-23-85" name="__codelineno-23-85"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if a type is registered in the container.&quot;&quot;&quot;</span>
<a id="__codelineno-23-86" name="__codelineno-23-86"></a>        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_container</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-23-87" name="__codelineno-23-87"></a>
<a id="__codelineno-23-88" name="__codelineno-23-88"></a>
<a id="__codelineno-23-89" name="__codelineno-23-89"></a><span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">(</span>
<a id="__codelineno-23-90" name="__codelineno-23-90"></a>    <span class="n">services</span><span class="o">=</span><span class="n">DependencyInjectorConnector</span><span class="p">(</span><span class="n">container</span><span class="p">),</span> <span class="n">show_error_details</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-23-91" name="__codelineno-23-91"></a><span class="p">)</span>
<a id="__codelineno-23-92" name="__codelineno-23-92"></a>
<a id="__codelineno-23-93" name="__codelineno-23-93"></a>
<a id="__codelineno-23-94" name="__codelineno-23-94"></a><span class="nd">@get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<a id="__codelineno-23-95" name="__codelineno-23-95"></a><span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">home</span><span class="p">(</span><span class="n">service</span><span class="p">:</span> <span class="n">SomeService</span><span class="p">):</span>
</span><a id="__codelineno-23-96" name="__codelineno-23-96"></a><span class="hll">    <span class="nb">print</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
</span><a id="__codelineno-23-97" name="__codelineno-23-97"></a><span class="hll">    <span class="c1"># DependencyInjector resolved the dependencies</span>
</span><a id="__codelineno-23-98" name="__codelineno-23-98"></a><span class="hll">    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">SomeService</span><span class="p">)</span>
</span><a id="__codelineno-23-99" name="__codelineno-23-99"></a><span class="hll">    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">api_client</span><span class="p">,</span> <span class="n">APIClient</span><span class="p">)</span>
</span><a id="__codelineno-23-100" name="__codelineno-23-100"></a><span class="hll">    <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Notes:</strong></p>
<ul>
<li>By using <strong>composition</strong>, we can integrate a third-party dependency injection
  library like <code>dependency_injector</code> into BlackSheep without tightly coupling
  the framework to the library.</li>
<li>We need a class like <code>DependencyInjectorConnector</code> that acts as a
  bridge between <code>dependency_injector</code> and BlackSheep.</li>
<li>When wiring dependencies for your application, you use the code API offered
  by <strong>Dependency Injector</strong>.</li>
<li>BlackSheep remains agnostic about the specific dependency injection library
  being used, but it needs the interface provided by the connector.</li>
<li>In this case, <strong>Dependency Injector</strong> <em>Provide</em> and <em>@inject</em> constructs are
  not needed on request handlers because BlackSheep handles the injection of
  parameters into request handlers and infers when it needs to resolve a type
  using the provided <em>connector</em>.</li>
</ul>
<p>In the example above, the name of the properties must match the type names
simply because <code>DependencyInjectorConnector</code> is obtaining <code>providers</code> by exact
type names. We could easily follow the convention of using <strong>snake_case</strong> or
a more robust approach of obtaining providers by types by changing the
connector's logic.</p>
<p>The connector can resolve types for controllers' <code>__init__</code> methods:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">APIClient</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="k">class</span><span class="w"> </span><span class="nc">SomeService</span><span class="p">:</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_client</span><span class="p">:</span> <span class="n">APIClient</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">api_client</span> <span class="o">=</span> <span class="n">api_client</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">AnotherService</span><span class="p">:</span> <span class="o">...</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="c1"># Define the Dependency Injector container</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">AppContainer</span><span class="p">(</span><span class="n">containers</span><span class="o">.</span><span class="n">DeclarativeContainer</span><span class="p">):</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>    <span class="n">APIClient</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Singleton</span><span class="p">(</span><span class="n">APIClient</span><span class="p">)</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>    <span class="n">SomeService</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span><span class="n">SomeService</span><span class="p">,</span> <span class="n">api_client</span><span class="o">=</span><span class="n">APIClient</span><span class="p">)</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>    <span class="n">AnotherService</span> <span class="o">=</span> <span class="n">providers</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span><span class="n">AnotherService</span><span class="p">)</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">TestController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">another_dep</span><span class="p">:</span> <span class="n">AnotherService</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_another_dep</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>            <span class="n">another_dep</span>  <span class="c1"># another_dep is resolved by Dependency Injector</span>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>        <span class="p">)</span>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>    <span class="nd">@app</span><span class="o">.</span><span class="n">controllers_router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/controller-test&quot;</span><span class="p">)</span>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">controller_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">SomeService</span><span class="p">):</span>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a>        <span class="c1"># DependencyInjector resolved the dependencies</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_another_dep</span><span class="p">,</span> <span class="n">AnotherService</span><span class="p">)</span>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">SomeService</span><span class="p">)</span>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">api_client</span><span class="p">,</span> <span class="n">APIClient</span><span class="p">)</span>
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
</code></pre></div>
<p><em><a href="https://github.com/Neoteroi/BlackSheep-Examples/blob/main/dependency-injector/main.py">Full example</a>.</em></p>
<div class="admonition hint">
<p class="admonition-title"><img alt="🐍" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f40d.svg" title=":snake:" /> Examples.</p>
<p>The <a href="https://github.com/Neoteroi/BlackSheep-Examples/blob/main/dependency-injector/"><em>BlackSheep-Examples</em></a>. repository contains examples for integrating with
<em>Dependency Injector</em>, including an example illustrating how to use <code>snake_case</code> for providers in
the Dependency Injector's container: <a href="https://github.com/Neoteroi/BlackSheep-Examples/blob/main/dependency-injector/docs/example2.py"><em>BlackSheep-Examples</em></a>.</p>
</div>
<div class="nt-contribs"><p class="nt-mod-time">Last modified on: 2025-05-02 10:56:38</p><div class="nt-contributors"><div class="nt-contributor nt-group-0" title="Roberto Prevato &lt;roberto.prevato@gmail.com&gt; (9)"><span class="nt-initials">RP</span></div><div class="nt-contributor nt-group-1" title="Elliot Waite &lt;elliot@elliotwaite.com&gt; (1)"><span class="nt-initials">EW</span></div><div class="nt-contributor nt-group-2" title="Roman Vlasenko &lt;56698047+Klavionik@users.noreply.github.com&gt; (1)"><span class="nt-initials">RV</span></div><div class="nt-contributor nt-group-3" title="techntools &lt;71767293+techntools@users.noreply.github.com&gt; (1)"><span class="nt-initials">T</span></div></div></div>





<!-- Giscus snippet -->
<script src="https://giscus.app/client.js"
    data-repo="Neoteroi/BlackSheep-Docs"
    data-repo-id="MDEwOlJlcG9zaXRvcnkzNzYyOTM4ODI="
    data-category="Q&A"
    data-category-id="DIC_kwDOFm3J-s4CSpF8"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="dark_tritanopia"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>

<!-- Synchronize Giscus theme with palette -->
<script>
  var giscus = document.querySelector("script[src*=giscus]")

  /* Set palette on initial load */
  var palette = __md_get("__palette")
  if (palette && typeof palette.color === "object") {
    var theme = palette.color.scheme === "slate" ? "dark" : "light"
    giscus.setAttribute("data-theme", theme)
  }

  /* Register event handlers after documented loaded */
  document.addEventListener("DOMContentLoaded", function() {
    var ref = document.querySelector("[data-md-component=palette]")
    ref.addEventListener("change", function() {
      var palette = __md_get("__palette")
      if (palette && typeof palette.color === "object") {
        var theme = palette.color.scheme === "slate" ? "dark" : "light"

        /* Instruct Giscus to change theme */
        var frame = document.querySelector(".giscus-frame")
        frame.contentWindow.postMessage(
          { giscus: { setConfig: { theme } } },
          "https://giscus.app"
        )
      }
    })
  })
</script>

                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../mvc-project-template/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Getting started: MVC">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Getting started: MVC
              </div>
            </div>
          </a>
        
        
          
          <a href="../openapi/" class="md-footer__link md-footer__link--next" aria-label="Next: OpenAPI Docs">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                OpenAPI Docs
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.footer", "content.code.copy", "content.action.view"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": 2}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../js/fullscreen.js"></script>
      
    
  </body>
</html>